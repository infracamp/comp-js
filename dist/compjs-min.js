/**
 * ComponentJS
 *
 * @author Matthias Leuffen <m@tth.es>
 */
class c{static req(e){return new CJ_Req(e)}}class ce{static _getElementById(e,t){var n=$("#"+e)[0];if(null===n)throw"Element #"+e+" not found";if(void 0!==t&&!n instanceof t)throw"Element #"+e+" not of type "+t;return n}static form(e){return ce._getElementById(e,CJFormElement)}static highlight(e){return ce._getElementById(e,CjHighlightElement)}static pane(e){return ce._getElementById(e,CJPaneElement)}static any(e){return ce._getElementById(e)}}class CJ_Req{constructor(e){this.request={url:e,method:"GET",body:null,success:!1,dataType:"text"}}withBody(e){return"GET"===this.request.method&&(this.request.method="POST"),(Array.isArray(e)||"object"==typeof e)&&(e=JSON.stringify(e)),this.request.body=e,this}set json(e){this._make_request(e,"json")}set plain(e){this._make_request(e,null)}set stream(e){this._make_request(e,"stream")}_make_request(e,t){this.request.success=function(n){"json"===t&&(n=JSON.parse(n)),e(n)},$.ajax(this.request)}}class CJHtmlElement extends HTMLElement{constructor(){super(),this.debug=!1}static get observedAttributes(){return["debug"]}attributeChangedCallback(e,t,n){switch(e){case"debug":this.debug=!0}}_log(e,t){this.debug&&console.log(this,...arguments)}}class CompCore{constructor(){this.ajaxOptions={dataType:"json",error:function(e){throw alert("Error executing form request."),"Error"}},this.ajaxOptionsHtml={error:function(e){throw alert("Error executing form request."),"Error"}}}static get instance(){return new CompCore}evalAttr(attrValue,event,ownerObj){if(console.log("eval",attrValue),null===attrValue)return null;if("string"==typeof attrValue){var context=function(e){return console.log(this),eval(attrValue)};console.log("owner",ownerObj);var ret=context.bind(ownerObj)(event);return"function"!=typeof ret?ret:ret.bind(ownerObj)(event)}if("function"==typeof attrValue)return attrValue(event,ownerObj);throw console.error("eval error:",attrValue),"Cannot evaluate expression - see output"}}class CjExecElement extends CJHtmlElement{constructor(){super()}connectedCallback(){var e=this;setTimeout(function(){var t=e.previousElementSibling;"PRE"!==t.tagName&&e._log("Cannot find sibling <pre> node"),t=t.querySelector("code"),e._log("textContent=",t.textContent),e.innerHTML=t.textContent},1)}}customElements.define("cj-exec",CjExecElement);class CjHighlightElement extends CJHtmlElement{constructor(){super(),this._value="",this._codeElement=null,this.lang="html"}static get observedAttributes(){return["lang",...CJHtmlElement.observedAttributes]}attributeChangedCallback(e,t,n){switch(super.attributeChangedCallback(e,t,n),e){case"lang":this.lang=n}}setCode(e,t){void 0===t&&(t=this.lang),this._value=e,null!==this._codeElement&&(this._codeElement.innerText=e,this._codeElement.classList.add(t),document.dispatchEvent(new Event("load")))}connectedCallback(){var e=this;setTimeout(function(){var t=e.innerHTML;e._log("content to highlight",t);var n=document.createElement("div");e.appendChild(n);var s=document.createElement("pre");n.appendChild(s);var o=document.createElement("code");s.appendChild(o),e._codeElement=o,o.classList.add(e.lang),o.style.whiteSpace="pre",""!==t.trim()&&(o.innerText=t,document.dispatchEvent(new Event("load")))},1)}}customElements.define("cj-highlight",CjHighlightElement);class CJFormElement extends CJHtmlElement{constructor(){super(),this._submittableElement=null,this._formElements=null,this.cf_onsubmit=null,self=this}get data(){return this.getData()}set data(e){this.setData(e)}static get observedAttributes(){return["onsubmit",...CJHtmlElement.observedAttributes]}attributeChangedCallback(e,t,n){switch(super.attributeChangedCallback(e,t,n),e){case"onsubmit":this.cf_onsubmit=n}}_gather_form_data(e,t){switch(e.tagName){case"INPUT":switch(e.type){case"checkbox":case"radio":return void(1==e.checked&&(t[e.name]=e.value))}case"SELECT":case"TEXTAREA":t[e.name]=$(e).val()}}getData(){var e={};return $("input, textarea, checkbox, select",this).each((t,n)=>this._gather_form_data(n,e)),this._log("getData():",e),e}_fill_form_single(e,t){var n=e.name;switch(void 0===n&&(n=e.id),e.tagName){case"INPUT":switch(e.type){case"checkbox":case"radio":return void(t[n]==e.value?e.checked=!0:e.checked=!1)}e.value=t[n];break;case"SELECT":case"TEXTAREA":e.value=t[n]}}setData(e){this._log("setData()",e),$("input, textarea, checkbox, select",this).each((t,n)=>this._fill_form_single(n,e))}_submit(e){this._log("_submit(",e,"); calling: onsubmit=",this.cf_onsubmit),CompCore.instance.evalAttr(this.cf_onsubmit,e,this)}connectedCallback(){var e=this;setTimeout(function(){e._submittableElement=e.querySelector("form"),null===e._submittableElement?(e._submittableElement=e.querySelector("button[type='submit']"),e._submittableElement.onclick=function(t){t.stopPropagation(),t.preventDefault(),e._submit(t)}):e._submittableElement.onsubmit=function(t){t.stopPropagation(),t.preventDefault(),e._submit(t)}},1)}}customElements.define("cj-form",CJFormElement);class CJOptionsElement extends CJHtmlElement{constructor(){super(),this._options=[],this._selectElementId=[]}static get observedAttributes(){return["for",...CJHtmlElement.observedAttributes]}attributeChangedCallback(e,t,n){switch(super.attributeChangedCallback(e,t,n),e){case"for":this._selectElementId=n}}refresh(){this.innerHTML="",this._options.forEach(i,e=>{if(this._log("add",i,e),"object"==typeof e)var t=e.value,n=e.text;else if("string"==typeof e)n=e;var s=document.createElement("option");s.setAttribute("value",t),s.textContent=n,this.appendChild(s)})}connectedCallback(){this._log("cj-objection connected()");var e=this;setTimeout(function(){console.log("muh"),""!==e.textContent.trim()&&(e._options=JSON.parse(e.textContent),e._log("Loading options preset from json:",e._options)),e.textContent="",e.refresh()},1)}}customElements.define("cj-options",CJOptionsElement);class CJPaneElement extends CJHtmlElement{constructor(){super(),this._src=null,this.targetNode=null,this._shadowDom=!1}static get observedAttributes(){return["src","shadow-dom",...CJHtmlElement.observedAttributes]}attributeChangedCallback(e,t,n){switch(super.attributeChangedCallback(e,t,n),e){case"src":this._src=n,null!=this._src&&this._loadUrl(this._src);break;case"shadow-dom":this._shadowDom=!0}}_loadUrl(e){console.log("load",e);var t=this;setTimeout(function(){jQuery.ajax(e,CompCore.instance.ajaxOptionsHtml).done(function(e){t.targetNode.innerHTML=e})},1)}connectedCallback(){var e=this;setTimeout(function(){e._shadowDom?e.targetNode=e.attachShadow({mode:"open"}):(e.targetNode=document.createElement("div"),e.appendChild(e.targetNode))},1)}}customElements.define("cj-pane",CJPaneElement);class CJRenderer{constructor(){CJRenderer.renderer=this}boolEval(scope,code){let ret=((scope,_code)=>{let __ret=null,gencode=`__ret = ${_code};`;return eval(gencode),__ret})(scope,code);return ret}forEval(scope,code,targetNode,tplNode){let reg=/^([a-zA-Z0-9_.\[\]]+)\s+as\s+([a-zA-Z0-9_.\[\]]+)$/.exec(code);console.log(reg);let genCode=`\n                for(let index = 0; index < ${reg[1]}.length; index++){\n                    ${reg[2]} = ${reg[1]}[index];\n                    let curClone = tplNode.cloneNode(false);\n                    //curClone.textContent = tplNode.textContent;\n                    targetNode.appendChild(curClone);\n                    for(let i = 0; i < tplNode.childNodes.length; i++) {\n                        this.renderInto(curClone, scope, tplNode.childNodes[i]);\n                    }\n                }`;return console.log("eval",genCode),eval(genCode)}evalText(scope,text){return text.replace(/\{\{(.*?)\}\}/g,function(match,p1){let __ret=null;return eval(`__ret = ${p1};`),__ret})}registerCallbacks(targetNode,scope){let eventAttr=targetNode.getAttribute("(click)");if(null!==eventAttr){let code=this.evalText(scope,eventAttr);targetNode.addEventListener("click",e=>{eval(code)})}}renderInto(e,t,n){if(void 0===n&&(n=this.templateDom),n instanceof HTMLTemplateElement)for(let s=0;s<n.content.childNodes.length;s++)this.renderInto(e,t,n.content.childNodes[s]);else{if(n instanceof Text){let s=n.cloneNode(!0);return s.textContent=this.evalText(t,s.textContent),void e.appendChild(s)}if(console.log(n),this.registerCallbacks(e,t),n.hasAttribute("if$")&&!1===this.boolEval(t,n.getAttribute("if$")))return!1;if(n.hasAttribute("for$")){let s=n.getAttribute("for$");return this.forEval(t,s,e,n),!1}{let s=n.cloneNode(!1);e.appendChild(s);for(let e=0;e<n.childNodes.length;e++)this.renderInto(s,t,n.childNodes[e])}}}parseNode(e,t){let n=e.cloneNode(!0);for(let t=0;t<e.childNodes.length;t++)e.removeChild(e.childNodes[t]);let s=document.createElement(e.tagName);this.renderInto(s,t,n),e.replaceWith(s)}}class CJTplElement extends HTMLElement{constructor(){super(),this.ajaxSrc=null,this.templateNode=null,this.targetNode=null}reload(){var e=new CJRenderer;this.targetNode.innerHTML="",e.renderInto(this.targetNode,{},this.templateNode)}static get observedAttributes(){return["ajax-src"]}attributeChangedCallback(e,t,n){switch(console.log(this),e){case"ajax-src":this.ajaxSrc=n}}connectedCallback(){var e=this;setTimeout(function(){console.log("ready");var t=new CJRenderer;e.templateNode=e.firstElementChild,e.targetNode=document.createElement("div"),e.appendChild(e.targetNode),console.log("connect",e.templateNode),t.renderInto(e.targetNode,{blah:"muh"},e.templateNode)},1)}}customElements.define("cj-tpl",CJTplElement);class CJAjaxFormElement extends CJFormElement{constructor(){super(),this.ajaxAction=null,this.preload=!1,this.onsuccess=null}static get observedAttributes(){return["ajax-action","preload","onsuccess",...CJFormElement.observedAttributes]}attributeChangedCallback(e,t,n){switch(super.attributeChangedCallback(e,t,n),e){case"ajax-action":this.ajaxAction=n;break;case"preload":this.preload=!0;break;case"onsuccess":this.onsuccess=n}}_on_submit_click(e){e.preventDefault(),e.stopPropagation(),this._submitButton.prop("disabled",!0),this._submitButton.addClass("loading");let formData={};this._formElements=$("input, textarea, checkbox",this),this._formElements.each((e,t)=>this._gather_form_data(t,formData)),this._formElements.prop("disabled",!0);let ajaxOptions=CompCore.instance.ajaxOptions;ajaxOptions.method="post",ajaxOptions.url=this.ajaxAction,ajaxOptions.data=JSON.stringify(formData),ajaxOptions.contentType="application/json; charset=utf-8",ajaxOptions.dataType="json";var self=this;jQuery.ajax(ajaxOptions).done(function(data){if(self._submitButton.removeClass("loading"),self._submitButton.addClass("saved"),null!==self.onsuccess){let r=eval(self.onsuccess);"function"==typeof r&&r(this,data)}})}connectedCallback(){if(this._submitButton=$("button[type='submit'], input[type='submit']",this),this._submitButton.click(e=>this._on_submit_click(e)),this._formElements=$("input, textarea, checkbox",this),this.preload){this._formElements.prop("disabled",!0);let e=this;jQuery.ajax(this.ajaxAction,CompCore.instance.ajaxOptions).done(function(t){e._fill_data(t),e._formElements.prop("disabled",!1)})}}}customElements.define("cj-ajax-form",CJAjaxFormElement);class CjScriptElement extends CJHtmlElement{constructor(){super()}connectedCallback(){var self=this;setTimeout(function(){var content=self.innerText;self.textContent="",console.log("eval",content),eval(content)},1)}}customElements.define("cj-script",CjScriptElement);